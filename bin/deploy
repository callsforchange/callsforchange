#!/bin/bash

STAGE=${1:-dev}

case $STAGE in
  dev)
    REGION=us-east-1
    GOOGLE_API_ENCRYPTED='AQECAHjpYz8DbAx51vlUqg/ksRQ6E+Q39Tci7KFTEct4HULyDAAAAIYwgYMGCSqGSIb3DQEHBqB2MHQCAQAwbwYJKoZIhvcNAQcBMB4GCWCGSAFlAwQBLjARBAwwdwZ2c1khZ67RgcICARCAQlEh/LDFoMaHSRX9vjFK0zkPz5iSU+R2+Ro6VB7n59LaMdxM5Q4Uh6owhRsWcw4w4Nf51lnF6i2m6GFQ3hw50MUUqQ=='
    MAILCHIMP_API_ENCRYPTED='AQECAHjpYz8DbAx51vlUqg/ksRQ6E+Q39Tci7KFTEct4HULyDAAAAIQwgYEGCSqGSIb3DQEHBqB0MHICAQAwbQYJKoZIhvcNAQcBMB4GCWCGSAFlAwQBLjARBAy7GpUsgioAkuCnOV4CARCAQIwILT8AX8i4DH78c2hknr35ywNK9TnFVJ1FcuPp6hjkYc1ZV9PP9zf1gNHmf/aZshXeO/JZFLC3G9yLoThEQ60='
    ADMIN_PASSWORD_ENCRYPTED='AQECAHjpYz8DbAx51vlUqg/ksRQ6E+Q39Tci7KFTEct4HULyDAAAAGkwZwYJKoZIhvcNAQcGoFowWAIBADBTBgkqhkiG9w0BBwEwHgYJYIZIAWUDBAEuMBEEDFYl4ilyaW6rbXDvDgIBEIAmDcVzX+UJkgCERYzSRteMRZUm91IanB5d73RlUo7ibENKWFfHY1A='
    TWILIO_ACCOUNT_SID_ENCRYPTED='AQECAHjpYz8DbAx51vlUqg/ksRQ6E+Q39Tci7KFTEct4HULyDAAAAIAwfgYJKoZIhvcNAQcGoHEwbwIBADBqBgkqhkiG9w0BBwEwHgYJYIZIAWUDBAEuMBEEDK9+NIJtgNhi8JxQ7wIBEIA98+uJfbYOoX/a2LjWL0hgpyvR5hx/GnXp21w9XNhH2d6p1f88n42D9rWymw/NMphEIz3+UkZj20nWWRlweQ=='
    TWILIO_AUTH_TOKEN_ENCRYPTED='AQECAHjpYz8DbAx51vlUqg/ksRQ6E+Q39Tci7KFTEct4HULyDAAAAH4wfAYJKoZIhvcNAQcGoG8wbQIBADBoBgkqhkiG9w0BBwEwHgYJYIZIAWUDBAEuMBEEDKTxe6sIQjYSEqSxvwIBEIA7kGK3krDpYAJFz7+pAJc81h2l/xwmGbl2fiYsawemV32FR/2vA/TThWn9H0FBr15rsDVnNrJ+XNWjgcI='
    MAILCHIMP_LIST_ID='8858c90897'
    ;;
  prod)
    REGION=us-west-2
    GOOGLE_API_ENCRYPTED='AQECAHjpYz8DbAx51vlUqg/ksRQ6E+Q39Tci7KFTEct4HULyDAAAAIYwgYMGCSqGSIb3DQEHBqB2MHQCAQAwbwYJKoZIhvcNAQcBMB4GCWCGSAFlAwQBLjARBAx5OkRWQP5W7BFx+esCARCAQq6340/AAZRSRXG8clPz0jp65Enyjhjjw3tnxAkFkmDVeg3iPnk9TDkNGhS3sluZC3PbT9FsoRjaMzFVWcReQ0L0bA=='
    MAILCHIMP_API_ENCRYPTED='AQECAHjpYz8DbAx51vlUqg/ksRQ6E+Q39Tci7KFTEct4HULyDAAAAIQwgYEGCSqGSIb3DQEHBqB0MHICAQAwbQYJKoZIhvcNAQcBMB4GCWCGSAFlAwQBLjARBAxAepTmmvHqyo5CWtkCARCAQH2raYzNQd85SLlpOOPtQhKq/eWy8D6ANx4Dv28QBZf6VzYncKXnvlgoSiHUoYilGJpFVI8/nRCoZrsVIzOVAu4='
    ADMIN_PASSWORD_ENCRYPTED='AQECAHjpYz8DbAx51vlUqg/ksRQ6E+Q39Tci7KFTEct4HULyDAAAAGkwZwYJKoZIhvcNAQcGoFowWAIBADBTBgkqhkiG9w0BBwEwHgYJYIZIAWUDBAEuMBEEDFYl4ilyaW6rbXDvDgIBEIAmDcVzX+UJkgCERYzSRteMRZUm91IanB5d73RlUo7ibENKWFfHY1A='
    TWILIO_ACCOUNT_SID_ENCRYPTED='AQECAHjpYz8DbAx51vlUqg/ksRQ6E+Q39Tci7KFTEct4HULyDAAAAIAwfgYJKoZIhvcNAQcGoHEwbwIBADBqBgkqhkiG9w0BBwEwHgYJYIZIAWUDBAEuMBEEDK9+NIJtgNhi8JxQ7wIBEIA98+uJfbYOoX/a2LjWL0hgpyvR5hx/GnXp21w9XNhH2d6p1f88n42D9rWymw/NMphEIz3+UkZj20nWWRlweQ=='
    TWILIO_AUTH_TOKEN_ENCRYPTED='AQECAHjpYz8DbAx51vlUqg/ksRQ6E+Q39Tci7KFTEct4HULyDAAAAH4wfAYJKoZIhvcNAQcGoG8wbQIBADBoBgkqhkiG9w0BBwEwHgYJYIZIAWUDBAEuMBEEDKTxe6sIQjYSEqSxvwIBEIA7kGK3krDpYAJFz7+pAJc81h2l/xwmGbl2fiYsawemV32FR/2vA/TThWn9H0FBr15rsDVnNrJ+XNWjgcI='
    MAILCHIMP_LIST_ID='e3efe7e0ae'
    ;;
  *)
    echo 'Unknown stage specified. Please run `deploy <stage>`' >&2
    exit 1
esac

echo -n 'Decrypt and export environment variables: '
export GOOGLE_API=$(aws --region $REGION kms decrypt --ciphertext-blob fileb://<(echo $GOOGLE_API_ENCRYPTED | base64 --decode) | jq -r '.Plaintext' | base64 --decode)
echo -n 'GOOGLE_API. '
export MAILCHIMP_API=$(aws --region $REGION kms decrypt --ciphertext-blob fileb://<(echo $MAILCHIMP_API_ENCRYPTED | base64 --decode) | jq -r '.Plaintext' | base64 --decode)
echo -n 'MAILCHIMP_API. '
export ADMIN_PASSWORD=$(aws --region $REGION kms decrypt --ciphertext-blob fileb://<(echo $ADMIN_PASSWORD_ENCRYPTED | base64 --decode) | jq -r '.Plaintext' | base64 --decode)
echo -n 'ADMIN_PASSWORD. '
export TWILIO_ACCOUNT_SID=$(aws --region $REGION kms decrypt --ciphertext-blob fileb://<(echo $TWILIO_ACCOUNT_SID_ENCRYPTED | base64 --decode) | jq -r '.Plaintext' | base64 --decode)
echo -n 'TWILIO_ACCOUNT_SID. '
export TWILIO_AUTH_TOKEN=$(aws --region $REGION kms decrypt --ciphertext-blob fileb://<(echo $TWILIO_AUTH_TOKEN_ENCRYPTED | base64 --decode) | jq -r '.Plaintext' | base64 --decode)
echo -n 'TWILIO_AUTH_TOKEN. '
export MAILCHIMP_LIST_ID
echo -n 'MAILCHIMP_LIST_ID. '
echo 'Done'

./node_modules/.bin/serverless deploy --region $REGION --stage "$STAGE"

# Do any necessary migrations on deploy
echo 'Running data migrations...'
./node_modules/.bin/serverless invoke --region $REGION --stage "$STAGE" -f migrate
