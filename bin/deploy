#!/bin/bash

STAGE=${1:-dev}

case $STAGE in
  dev)
    REGION=us-east-1
    GOOGLE_API_ENCRYPTED='AQECAHjpYz8DbAx51vlUqg/ksRQ6E+Q39Tci7KFTEct4HULyDAAAAIYwgYMGCSqGSIb3DQEHBqB2MHQCAQAwbwYJKoZIhvcNAQcBMB4GCWCGSAFlAwQBLjARBAx5OkRWQP5W7BFx+esCARCAQq6340/AAZRSRXG8clPz0jp65Enyjhjjw3tnxAkFkmDVeg3iPnk9TDkNGhS3sluZC3PbT9FsoRjaMzFVWcReQ0L0bA=='
    MAILCHIMP_API_ENCRYPTED='AQECAHjpYz8DbAx51vlUqg/ksRQ6E+Q39Tci7KFTEct4HULyDAAAAIQwgYEGCSqGSIb3DQEHBqB0MHICAQAwbQYJKoZIhvcNAQcBMB4GCWCGSAFlAwQBLjARBAxAepTmmvHqyo5CWtkCARCAQH2raYzNQd85SLlpOOPtQhKq/eWy8D6ANx4Dv28QBZf6VzYncKXnvlgoSiHUoYilGJpFVI8/nRCoZrsVIzOVAu4='
    MAILCHIMP_LIST_ID='025149da91'
    ;;
  prod)
    REGION=us-west-2
    GOOGLE_API_ENCRYPTED='AQECAHjpYz8DbAx51vlUqg/ksRQ6E+Q39Tci7KFTEct4HULyDAAAAIYwgYMGCSqGSIb3DQEHBqB2MHQCAQAwbwYJKoZIhvcNAQcBMB4GCWCGSAFlAwQBLjARBAx5OkRWQP5W7BFx+esCARCAQq6340/AAZRSRXG8clPz0jp65Enyjhjjw3tnxAkFkmDVeg3iPnk9TDkNGhS3sluZC3PbT9FsoRjaMzFVWcReQ0L0bA=='
    MAILCHIMP_API_ENCRYPTED='AQECAHjpYz8DbAx51vlUqg/ksRQ6E+Q39Tci7KFTEct4HULyDAAAAIQwgYEGCSqGSIb3DQEHBqB0MHICAQAwbQYJKoZIhvcNAQcBMB4GCWCGSAFlAwQBLjARBAxAepTmmvHqyo5CWtkCARCAQH2raYzNQd85SLlpOOPtQhKq/eWy8D6ANx4Dv28QBZf6VzYncKXnvlgoSiHUoYilGJpFVI8/nRCoZrsVIzOVAu4='
    MAILCHIMP_LIST_ID='e3efe7e0ae'
    ;;
  *)
    echo 'Unknown stage specified. Please run `deploy <stage>`' >&2
    exit 1
esac

echo -n 'Decrypt and export environment variables: '
export GOOGLE_API=$(aws --region $REGION kms decrypt --ciphertext-blob fileb://<(echo $GOOGLE_API_ENCRYPTED | base64 --decode) | jq -r '.Plaintext' | base64 --decode)
echo -n 'GOOGLE_API. '
export MAILCHIMP_API=$(aws --region $REGION kms decrypt --ciphertext-blob fileb://<(echo $MAILCHIMP_API_ENCRYPTED | base64 --decode) | jq -r '.Plaintext' | base64 --decode)
echo -n 'MAILCHIMP_API. '
export MAILCHIMP_LIST_ID
echo -n 'MAILCHIMP_LIST_ID. '
echo 'Done'

./node_modules/.bin/serverless deploy --region $REGION --stage $STAGE -v

echo 'Running data migrations...'
./node_modules/.bin/serverless invoke --region $REGION --stage $STAGE -f migrate
